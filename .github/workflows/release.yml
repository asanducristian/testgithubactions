name: Release (tag + GitHub Release)

on:
    workflow_dispatch:
        inputs:
            bump:
                description: "If tag exists, bump patch automatically (requires approval)"
                type: boolean
                required: true
                default: false

permissions:
    contents: write

concurrency:
    group: release
    cancel-in-progress: false

jobs:
    plan:
        runs-on: ubuntu-latest
        outputs:
            tag: ${{ steps.meta.outputs.tag }}
            tag_exists: ${{ steps.tagcheck.outputs.exists }}
        steps:
            - uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Determine version/tag
              id: meta
              shell: bash
              run: |
                  VERSION="$(node -p "require('./package.json').version")"
                  [ -n "$VERSION" ] || (echo "ERROR: No version in package.json" >&2 && exit 1)
                  echo "tag=v$VERSION" >> "$GITHUB_OUTPUT"

            - name: Check if tag exists
              id: tagcheck
              shell: bash
              run: |
                  TAG="${{ steps.meta.outputs.tag }}"
                  if git ls-remote --tags origin "refs/tags/${TAG}" | grep -q .; then
                    echo "exists=true" >> "$GITHUB_OUTPUT"
                  else
                    echo "exists=false" >> "$GITHUB_OUTPUT"
                  fi

    bump:
        needs: plan
        if: needs.plan.outputs.tag_exists == 'true' && inputs.bump == true
        runs-on: ubuntu-latest
        environment: release-bump
        permissions:
            contents: write
        outputs:
            tag: ${{ steps.meta2.outputs.tag }}
        steps:
            - uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - uses: actions/setup-node@v4
              with:
                  node-version: 20
                  cache: npm

            - name: Configure git identity
              shell: bash
              run: |
                  git config user.name "github-actions[bot]"
                  git config user.email "github-actions[bot]@users.noreply.github.com"

            - name: Bump patch version + commit + push
              shell: bash
              run: |
                  npm ci
                  npm version patch --no-git-tag-version
                  git add package.json package-lock.json 2>/dev/null || true
                  git commit -m "chore(release): bump version"
                  git push origin HEAD:main

            - name: Refresh version/tag after bump
              id: meta2
              shell: bash
              run: |
                  VERSION="$(node -p "require('./package.json').version")"
                  [ -n "$VERSION" ] || (echo "ERROR: No bumped version" >&2 && exit 1)
                  echo "tag=v$VERSION" >> "$GITHUB_OUTPUT"

            - name: Ensure bumped tag does not exist
              shell: bash
              run: |
                  TAG="${{ steps.meta2.outputs.tag }}"
                  if git ls-remote --tags origin "refs/tags/${TAG}" | grep -q .; then
                    echo "ERROR: After bump, tag ${TAG} already exists. Refusing to release." >&2
                    exit 1
                  fi

    release:
        needs: [plan, bump]
        # Run if tag is new OR (tag exists and bump was requested/approved)
        if: needs.plan.outputs.tag_exists == 'false' || (needs.plan.outputs.tag_exists == 'true' && inputs.bump == true)
        runs-on: ubuntu-latest
        steps:
            - name: Decide final tag
              id: final
              shell: bash
              run: |
                  FINAL_TAG="${{ needs.plan.outputs.tag }}"
                  if [ -n "${{ needs.bump.outputs.tag }}" ]; then
                    FINAL_TAG="${{ needs.bump.outputs.tag }}"
                  fi
                  echo "tag=$FINAL_TAG" >> "$GITHUB_OUTPUT"

            - name: Fail if tag exists and bump not allowed
              if: needs.plan.outputs.tag_exists == 'true' && inputs.bump == false
              shell: bash
              run: |
                  echo "Tag already exists (${{ needs.plan.outputs.tag }}). Re-run with bump=true." >&2
                  exit 1

            - uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - uses: actions/setup-node@v4
              with:
                  node-version: 20
                  cache: npm

            - name: Install, test, build
              run: |
                  npm ci
                  npm test
                  npm run build

            - name: Create release assets
              shell: bash
              run: |
                  TAG="${{ steps.final.outputs.tag }}"
                  tar -czf "dist-${TAG}.tar.gz" dist/
                  sha256sum "dist-${TAG}.tar.gz" > "dist-${TAG}.tar.gz.sha256"

            - name: Create and push tag
              shell: bash
              run: |
                  TAG="${{ steps.final.outputs.tag }}"
                  git config user.name "github-actions[bot]"
                  git config user.email "github-actions[bot]@users.noreply.github.com"

                  # race-safe check (again)
                  if git ls-remote --tags origin "refs/tags/${TAG}" | grep -q .; then
                    echo "ERROR: Tag ${TAG} already exists on origin." >&2
                    exit 1
                  fi

                  git tag -a "$TAG" -m "Release $TAG"
                  git push origin "$TAG"

            - name: Create GitHub Release
              uses: softprops/action-gh-release@v2
              with:
                  tag_name: ${{ steps.final.outputs.tag }}
                  name: ${{ steps.final.outputs.tag }}
                  generate_release_notes: true
                  files: |
                      dist-${{ steps.final.outputs.tag }}.tar.gz
                      dist-${{ steps.final.outputs.tag }}.tar.gz.sha256
